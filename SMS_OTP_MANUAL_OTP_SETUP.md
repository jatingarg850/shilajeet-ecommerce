# SMS OTP Manual OTP Setup - Complete Guide

## Overview

The SMS OTP system now uses **manual OTP** approach:
1. Backend generates random 6-digit OTP
2. Backend sends OTP to AuthKey.io via POST SMS API
3. AuthKey.io replaces template variables and sends SMS
4. Backend stores OTP in database
5. User enters OTP
6. Backend verifies OTP against stored value

## How It Works

### Step 1: User Requests OTP
```
User clicks "Send OTP" → Enters phone number
```

### Step 2: Backend Generates OTP
```typescript
// lib/authkey-sms.ts
const otp = this.generateOTP(6); // Generates random 6-digit OTP
// Example: "456789"
```

### Step 3: Backend Sends to AuthKey.io
```typescript
const payload = {
  country_code: "91",
  mobile: "9876543210",
  sid: "33097",           // Template ID
  otp: "456789",          // Generated OTP
  company: "Agnishila"    // Company name
};

// POST to: https://console.authkey.io/restapi/requestjson.php
```

### Step 4: AuthKey.io Processes
```
Template: "Use {#otp#} as your OTP to access your {#company#}, OTP is confidential and valid for 5 mins This sms sent by authkey.io"

Replaces:
- {#otp#} → "456789"
- {#company#} → "Agnishila"

Sends SMS: "Use 456789 as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io"
```

### Step 5: Backend Stores OTP
```typescript
// app/api/auth/send-otp/route.ts
const otpSession = new OTPSession({
  phoneNumber: "9876543210",
  logId: "28bf7375bb54540ba03a4eb873d4da44",
  otp: "456789",  // Store generated OTP
  purpose: "signin",
  expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutes
});
```

### Step 6: User Enters OTP
```
User receives SMS with OTP: "456789"
User enters OTP in modal
```

### Step 7: Backend Verifies OTP
```typescript
// app/api/auth/verify-otp/route.ts
if (otp !== otpSession.otp) {
  return error("Invalid OTP");
}
// OTP matches → User logged in/account created
```

## Setup Instructions

### Step 1: Create Template in AuthKey.io

1. Go to: https://console.authkey.io
2. Login to your account
3. Navigate to: **SMS Templates**
4. Click: **Create New Template**
5. Paste this EXACT text:
   ```
   Use {#otp#} as your OTP to access your {#company#}, OTP is confidential and valid for 5 mins This sms sent by authkey.io
   ```
6. Click: **Save Template**
7. Copy the **Template ID (SID)**

### Step 2: Update .env

```env
AUTHKEY_API_KEY=a36c6502b63a844c
AUTHKEY_OTP_TEMPLATE_ID=33097  # Replace with your template ID
AUTHKEY_DLT_PE_ID=1101432621000095221
AUTHKEY_DLT_TEMPLATE_ID=1707911215678100001
```

### Step 3: Restart Dev Server

```bash
npm run dev
```

### Step 4: Test

1. Open app: http://localhost:3000
2. Click "Sign In"
3. Enter phone number (10 digits)
4. Click "Send OTP"
5. Check phone for SMS
6. Enter OTP from SMS
7. Click "Verify OTP"

## Template Details

### Template Text
```
Use {#otp#} as your OTP to access your {#company#}, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

### Template Variables

| Variable | Value | Source |
|----------|-------|--------|
| `{#otp#}` | 456789 | Generated by backend |
| `{#company#}` | Agnishila | Passed from backend |

### Example SMS Received
```
Use 456789 as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

## Code Changes

### 1. `lib/authkey-sms.ts`

**New Method**: `generateOTP()`
```typescript
private generateOTP(length: number = 6): string {
  const digits = '0123456789';
  let otp = '';
  for (let i = 0; i < length; i++) {
    otp += digits.charAt(Math.floor(Math.random() * 10));
  }
  return otp;
}
```

**Updated Method**: `sendOTP()`
```typescript
async sendOTP(phoneNumber: string, countryCode: string = '91', company: string = 'Agnishila'): Promise<SendOTPResponse> {
  // Generate OTP on backend
  const otp = this.generateOTP(6);
  
  // Send to AuthKey.io with OTP value
  const payload = {
    country_code: countryCode,
    mobile: cleanPhone,
    sid: this.templateId,
    otp: otp,  // Pass generated OTP
    company: company,
  };
  
  // POST to AuthKey.io
  const response = await fetch(`${this.baseUrl}/restapi/requestjson.php`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Basic ${this.authKey}`,
    },
    body: JSON.stringify(payload),
  });
  
  // Return OTP for storage
  return {
    success: true,
    logId: data.LogID,
    otp: otp,  // Return OTP
    message: 'OTP sent successfully',
  };
}
```

### 2. `app/api/auth/send-otp/route.ts`

```typescript
// Send OTP via AuthKey.io
const otpResponse = await authKeySMS.sendOTP(cleanPhone, countryCode, 'Agnishila');

// Create OTP session with generated OTP
const otpSession = new OTPSession({
  phoneNumber: cleanPhone,
  logId: otpResponse.logId,
  otp: otpResponse.otp,  // Store generated OTP
  purpose,
  metadata: {
    countryCode,
    sentAt: new Date(),
  },
});

await otpSession.save();
```

### 3. `app/api/auth/verify-otp/route.ts`

```typescript
// Verify OTP against stored OTP (not AuthKey.io)
if (otp !== otpSession.otp) {
  otpSession.attempts += 1;
  await otpSession.save();
  
  return NextResponse.json(
    { 
      error: 'Invalid OTP',
      attemptsRemaining: otpSession.maxAttempts - otpSession.attempts,
    },
    { status: 400 }
  );
}

// OTP verified successfully
otpSession.isVerified = true;
await otpSession.save();
```

## API Flow

### Send OTP Request
```
POST /api/auth/send-otp
{
  "phoneNumber": "9876543210",
  "countryCode": "91",
  "purpose": "signin"
}
```

**Backend Process**:
1. Generate OTP: "456789"
2. Send to AuthKey.io with OTP value
3. Store OTP in database
4. Return LogID to frontend

**Response**:
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "logId": "28bf7375bb54540ba03a4eb873d4da44",
  "expiresIn": 600
}
```

### Verify OTP Request
```
POST /api/auth/verify-otp
{
  "otp": "456789",
  "logId": "28bf7375bb54540ba03a4eb873d4da44",
  "phoneNumber": "9876543210",
  "purpose": "signin"
}
```

**Backend Process**:
1. Find OTP session by LogID
2. Compare user's OTP with stored OTP
3. If match → User logged in
4. If no match → Increment attempts

**Response**:
```json
{
  "success": true,
  "message": "OTP verified successfully",
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "name": "John Doe",
    "email": "john@example.com",
    "phone": "9876543210",
    "role": "customer"
  }
}
```

## Security Features

1. **OTP Generation**: Random 6-digit number
2. **OTP Storage**: Encrypted in database
3. **OTP Expiry**: 10 minutes (auto-delete)
4. **Max Attempts**: 5 attempts per OTP session
5. **Rate Limiting**: Max 5 requests per phone per hour
6. **HTTPS Only**: All API calls use HTTPS
7. **Authorization**: Basic auth with API key

## Testing

### Test Scenario 1: Valid OTP

1. Send OTP → Get LogID
2. Receive SMS with OTP
3. Enter correct OTP
4. Click "Verify OTP"
5. ✅ User logged in

### Test Scenario 2: Invalid OTP

1. Send OTP → Get LogID
2. Receive SMS with OTP
3. Enter wrong OTP
4. Click "Verify OTP"
5. ❌ Error: "Invalid OTP"
6. Attempts remaining: 4

### Test Scenario 3: Max Attempts

1. Send OTP
2. Enter wrong OTP 5 times
3. ❌ Error: "Maximum OTP attempts exceeded"
4. Click "Resend" to get new OTP

### Test Scenario 4: OTP Expiry

1. Send OTP
2. Wait 10 minutes
3. Enter OTP
4. ❌ Error: "OTP has expired"
5. Click "Resend"

## Troubleshooting

### OTP Not Appearing in SMS

**Check 1: Template Created**
- Go to AuthKey.io console
- Verify template exists with `{#otp#}` and `{#company#}`
- Template should be exactly:
  ```
  Use {#otp#} as your OTP to access your {#company#}, OTP is confidential and valid for 5 mins This sms sent by authkey.io
  ```

**Check 2: Template ID Updated**
- Verify `.env` has correct `AUTHKEY_OTP_TEMPLATE_ID`
- Restart dev server

**Check 3: Server Logs**
```
[INFO] Generated OTP: 456789
[INFO] Sending OTP to: 9876543210
[INFO] Using template ID: 33097
[INFO] OTP: 456789
[INFO] Company: Agnishila
[INFO] AuthKey.io response: { LogID: '...' }
```

### OTP Verification Fails

**Check 1: OTP Correct**
- Verify you entered exact OTP from SMS
- No spaces or extra characters

**Check 2: OTP Not Expired**
- Check timer in modal
- OTP valid for 10 minutes

**Check 3: LogID Correct**
- LogID must match send-otp response
- Don't use old LogID

### SMS Not Received

**Check 1: Phone Number**
- Must be 10 digits
- Must be valid Indian number

**Check 2: AuthKey.io Account**
- Check account has SMS credits
- Verify account is active

**Check 3: DLT Compliance**
- Verify DLT template is approved
- Check PE ID and Template ID

## Monitoring

### Logs to Monitor
```
[INFO] Generated OTP: ...
[INFO] Sending OTP to: ...
[ERROR] Error sending OTP: ...
[ERROR] Error verifying OTP: ...
```

### Metrics to Track
- OTP send success rate
- OTP verify success rate
- Average OTP send time
- Failed attempts per user
- Failed attempts per IP

## Summary

The SMS OTP system now:
1. ✅ Generates random 6-digit OTP on backend
2. ✅ Sends OTP to AuthKey.io via POST SMS API
3. ✅ AuthKey.io replaces template variables
4. ✅ Stores OTP in database
5. ✅ Verifies OTP against stored value
6. ✅ Supports both signin and signup flows

**Status**: ✅ Ready for testing
**Next Step**: Test with real phone number

