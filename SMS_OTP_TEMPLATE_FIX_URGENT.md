# URGENT: SMS OTP Template Fix - Use {#2fa#} Not {#otp#}

## Problem

The OTP is not appearing in SMS because:
- We're using the **2FA API** (which auto-generates OTP)
- But the template uses `{#otp#}` (which is for manual OTP)
- The 2FA API uses `{#2fa#}` for auto-generated OTP

**Current SMS received:**
```
Use  as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

**Should be:**
```
Use 123456 as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

## Solution

### Step 1: Delete Old Template

1. Go to: https://console.authkey.io
2. Login to your account
3. Navigate to: **SMS Templates**
4. Find your old template (with `{#otp#}`)
5. Click **Delete**

### Step 2: Create NEW Template with {#2fa#}

1. Click: **Create New Template**
2. Paste this EXACT text:
   ```
   Use {#2fa#} as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
   ```
3. Click: **Save Template**
4. **Copy the Template ID (SID)** that appears

### Step 3: Update .env

Update your `.env` file with the NEW template ID:

```env
AUTHKEY_API_KEY=a36c6502b63a844c
AUTHKEY_OTP_TEMPLATE_ID=YOUR_NEW_TEMPLATE_ID_HERE
AUTHKEY_DLT_PE_ID=1101432621000095221
AUTHKEY_DLT_TEMPLATE_ID=1707911215678100001
```

### Step 4: Restart Dev Server

```bash
# Stop: Ctrl+C
# Start: npm run dev
```

### Step 5: Test

1. Open app: http://localhost:3000
2. Click "Sign In"
3. Enter phone number
4. Click "Send OTP"
5. **Check phone for SMS**

**You should now receive:**
```
Use 123456 as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

## Why This Works

According to AuthKey.io documentation:

**2FA API** (auto-generates OTP):
- Endpoint: `/restapi/request.php?sid=TEMPLATE_ID`
- Uses: `{#2fa#}` variable
- AuthKey.io generates random OTP
- Replaces `{#2fa#}` with generated OTP

**POST SMS API** (manual OTP):
- Endpoint: `/restapi/requestjson.php`
- Uses: Custom variables like `{#otp#}`, `{#company#}`
- You pass the OTP value
- AuthKey.io replaces variables with your values

We're using the **2FA API** because it auto-generates OTP, so we must use `{#2fa#}`.

## Key Difference

| API | Endpoint | Variable | OTP Source |
|-----|----------|----------|-----------|
| 2FA API | `/restapi/request.php` | `{#2fa#}` | Auto-generated by AuthKey.io |
| POST SMS API | `/restapi/requestjson.php` | `{#otp#}` | You pass the OTP value |

## Template Comparison

**WRONG** (uses POST SMS API variable):
```
Use {#otp#} as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

**CORRECT** (uses 2FA API variable):
```
Use {#2fa#} as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

The ONLY change is: `{#otp#}` â†’ `{#2fa#}`

## Code Changes

The backend code has been updated to use the 2FA API:

**File**: `lib/authkey-sms.ts`

```typescript
// Using 2FA API endpoint (GET request)
const url = `${this.baseUrl}/restapi/request.php?authkey=${this.authKey}&mobile=${cleanPhone}&country_code=${countryCode}&sid=${this.templateId}`;

// AuthKey.io automatically generates OTP and replaces {#2fa#} in template
```

## Verification Checklist

- [ ] Old template deleted from AuthKey.io
- [ ] New template created with `{#2fa#}`
- [ ] Template ID copied
- [ ] `.env` updated with new template ID
- [ ] Dev server restarted
- [ ] Test SMS received with OTP number
- [ ] OTP verification works
- [ ] User account created/logged in

## Expected Result

After following these steps:

1. âœ… OTP sends successfully
2. âœ… SMS received with OTP number:
   ```
   Use 123456 as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
   ```
3. âœ… OTP verification works
4. âœ… User can sign in/sign up

## Summary

**Change template from:**
```
Use {#otp#} as your OTP to access your {#company#}, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

**To:**
```
Use {#2fa#} as your OTP to access your Agnishila, OTP is confidential and valid for 5 mins This sms sent by authkey.io
```

**Note**: The `{#company#}` variable is removed because the 2FA API doesn't support custom variables. The company name "Agnishila" is hardcoded in the template.

---

**Status**: ðŸ”´ URGENT - Template needs to be updated in AuthKey.io console
**Action Required**: Update template with `{#2fa#}` instead of `{#otp#}`
**Time to Fix**: 2 minutes

